<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Writing Automated Tests for Galaxy</title>
        
            <script async defer data-domain="training.galaxyproject.org" src="https://plausible.galaxyproject.eu/js/plausible.js"></script>

        
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />
        <link rel="alternate" type="application/atom+xml" href="/training-material/feed.xml" />
        <link rel="canonical" href="https://training.galaxyproject.org/training-material/topics/dev/tutorials/writing_tests/tutorial.html" />
        <link rel="license" href="https://creativecommons.org/licenses/by/4.0/" />

        <meta name="DC.identifier" content="https://github.com/galaxyproject/training-material" />
<meta name="DC.type" content="text" />
<meta name="DC.title" content="Writing Automated Tests for Galaxy" />
<meta name="DC.publisher" content="Galaxy Training Network" />
<meta name="DC.date" content="2023-01-23 14:30:52 +0000" />
<meta name="DC.creator" content="John Davis" />
<meta name="DC.creator" content="John Chilton" />

        
        
        
        
        <meta name="description" content="Galaxy is an open-source project. Everyone can contribute..." />
        <meta property="og:site_name" content="Galaxy Training Network" />
        <meta property="og:title" content="Galaxy Training: Writing Automated Tests for Galaxy" />
        <meta property="og:description" content="Galaxy is an open-source project. Everyone can contribute..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />

        
        <script type="application/ld+json">
            


{
  "@context": "http://schema.org",
  "@type": "LearningResource",
  "http://purl.org/dc/terms/conformsTo": {
    "@id": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
    "@type": "CreativeWork"
  },
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "Students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "dateModified": "2023-01-23 14:30:52 +0000",
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Writing Automated Tests for Galaxy",
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "isFamilyFriendly": true,
  "license": "https://spdx.org/licenses/CC-BY-4.0.html",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "identifier": "https://github.com/galaxyproject/training-material",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "The text aims to be as accessible as possible. Image descriptions will vary per tutorial, from images being completely inaccessible, to images with good descriptions for non-visual users.",
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Development in Galaxy",
    "description": "Galaxy is an open-source project. Everyone can contribute to its development with core Galaxy development, integration of softwares in Galaxy environment, ...",
    "url": "https://training.galaxyproject.org/training-material/topics/dev/"
  },
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Writing Automated Tests for Galaxy' tutorial",
  "url": "https://training.galaxyproject.org/training-material/topics/dev/tutorials/writing_tests/tutorial.html",
  "timeRequired": "PT3H",
  "keywords": "dev",
  "description": "The objectives are:\n - Learn about the different types of automated tests in Galaxy\n - Learn to write API tests\n - Learn to write unit tests\n\n",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "competencyRequired": [
    "Familiarity with basic Git commands",
    "Basic knowledge of Python and JavaScript",
    "Mac OS or Linux that can run Galaxy & your favorite IDE or editor",
    {
      "@context": "http://schema.org",
      "@type": "LearningResource",
      "url": "https://training.galaxyproject.org/training-material/topics/dev/tutorials/architecture/slides.html",
      "name": "Galaxy Code Architecture",
      "description": "Slides for 'Galaxy Code Architecture' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    }
  ],
  "author": [
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "http://purl.org/dc/terms/conformsTo": {
        "@id": "https://bioschemas.org/profiles/Person/0.2-DRAFT-2019_07_19",
        "@type": "Person"
      },
      "url": "https://training.galaxyproject.org/training-material/hall-of-fame/jdavcs/",
      "mainEntityOfPage": "https://training.galaxyproject.org/training-material/hall-of-fame/jdavcs/",
      "name": "John Davis",
      "image": "https://avatars.githubusercontent.com/jdavcs",
      "description": "A contributor to the GTN project.",
      "memberOf": [
        {
          "@type": "Organization",
          "email": "galaxytrainingnetwork@gmail.com",
          "name": "Galaxy Training Network",
          "url": "https://galaxyproject.org/teach/gtn/"
        }
      ],
      "identifier": "https://orcid.org/0000-0002-1363-1245",
      "orcid": "https://orcid.org/0000-0002-1363-1245"
    },
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "http://purl.org/dc/terms/conformsTo": {
        "@id": "https://bioschemas.org/profiles/Person/0.2-DRAFT-2019_07_19",
        "@type": "Person"
      },
      "url": "https://training.galaxyproject.org/training-material/hall-of-fame/jmchilton/",
      "mainEntityOfPage": "https://training.galaxyproject.org/training-material/hall-of-fame/jmchilton/",
      "name": "John Chilton",
      "image": "https://avatars.githubusercontent.com/jmchilton",
      "description": "A contributor to the GTN project.",
      "memberOf": [
        {
          "@type": "Organization",
          "email": "galaxytrainingnetwork@gmail.com",
          "name": "Galaxy Training Network",
          "url": "https://galaxyproject.org/teach/gtn/"
        }
      ],
      "identifier": "https://orcid.org/0000-0002-6794-0756",
      "orcid": "https://orcid.org/0000-0002-6794-0756"
    }
  ],
  "contributor": [
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "http://purl.org/dc/terms/conformsTo": {
        "@id": "https://bioschemas.org/profiles/Person/0.2-DRAFT-2019_07_19",
        "@type": "Person"
      },
      "url": "https://training.galaxyproject.org/training-material/hall-of-fame/jdavcs/",
      "mainEntityOfPage": "https://training.galaxyproject.org/training-material/hall-of-fame/jdavcs/",
      "name": "John Davis",
      "image": "https://avatars.githubusercontent.com/jdavcs",
      "description": "A contributor to the GTN project.",
      "memberOf": [
        {
          "@type": "Organization",
          "email": "galaxytrainingnetwork@gmail.com",
          "name": "Galaxy Training Network",
          "url": "https://galaxyproject.org/teach/gtn/"
        }
      ],
      "identifier": "https://orcid.org/0000-0002-1363-1245",
      "orcid": "https://orcid.org/0000-0002-1363-1245"
    },
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "http://purl.org/dc/terms/conformsTo": {
        "@id": "https://bioschemas.org/profiles/Person/0.2-DRAFT-2019_07_19",
        "@type": "Person"
      },
      "url": "https://training.galaxyproject.org/training-material/hall-of-fame/jmchilton/",
      "mainEntityOfPage": "https://training.galaxyproject.org/training-material/hall-of-fame/jmchilton/",
      "name": "John Chilton",
      "image": "https://avatars.githubusercontent.com/jmchilton",
      "description": "A contributor to the GTN project.",
      "memberOf": [
        {
          "@type": "Organization",
          "email": "galaxytrainingnetwork@gmail.com",
          "name": "Galaxy Training Network",
          "url": "https://galaxyproject.org/teach/gtn/"
        }
      ],
      "identifier": "https://orcid.org/0000-0002-6794-0756",
      "orcid": "https://orcid.org/0000-0002-6794-0756"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Development in Galaxy",
      "description": "Galaxy is an open-source project. Everyone can contribute to its development with core Galaxy development, integration of softwares in Galaxy environment, ...",
      "url": "https://training.galaxyproject.org/training-material/topics/dev/"
    }
  ]
}
        </script>
        
    </head>
    <body data-spy="scroll" data-target="#toc">
        <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>
        <header>
    <nav class="navbar navbar-expand-md navbar-dark" aria-label="Site Navigation">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        
                        <a class="nav-link" href="/training-material/topics/dev" title="Go back to list of tutorials">
                            <i class="far fa-folder" aria-hidden="true"></i> Development in Galaxy
                        </a>
                        
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Languages">
                            <i class="fas fa-language" aria-hidden="true"></i><span class="visually-hidden">language</span> Languages
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                            
                              <strong class="dropdown-header">Automatic Translations</strong>
            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/dev/tutorials/writing_tests/tutorial.html&edit-text=&act=url">
                            Français
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/dev/tutorials/writing_tests/tutorial.html&edit-text=&act=url">
                            日本語
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/dev/tutorials/writing_tests/tutorial.html&edit-text=&act=url">
                            Español
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/dev/tutorials/writing_tests/tutorial.html&edit-text=&act=url">
                            Português
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/dev/tutorials/writing_tests/tutorial.html&edit-text=&act=url">
                            العربية
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/dev/tutorials/writing_tests/tutorial.html&edit-text=&act=url" title="">
                            And more!
                            </a>
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <!-- disable Tess for now
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>
        -->

        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQs">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> FAQs
        </a>
        
        
        <a class="dropdown-item" href="/training-material/topics/dev/faqs/" title="Check our FAQs for the Development in Galaxy topic">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Topic FAQs
        </a>
        
        
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            <i class="far fa-comments" aria-hidden="true"></i><span class="visually-hidden">feedback</span> Galaxy Help Forum
        </a>
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Discuss on gitter">
           <i class="fab fa-gitter" aria-hidden="true"></i><span class="visually-hidden">gitter</span> Discuss on Gitter
        </a>
    </div>
</li>


                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Extras">
        <i class="far fa-star" aria-hidden="true"></i><span class="visually-hidden">galaxy-star</span> Extras
    </a>
    <div class="dropdown-menu dropdown-menu-right">

        
        <a class="dropdown-item" href="https://github.com/galaxyproject/training-material/edit/main/topics/dev/tutorials/writing_tests/tutorial.md" title="Edit on GitHub">
          <i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit on GitHub
        </a>

        <a class="dropdown-item" href="/training-material/stats.html" title="Show view statistics about this repository">
            <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN statistics
        </a>

        <a class="dropdown-item" href="https://plausible.galaxyproject.eu/training.galaxyproject.org?period=12mo&page=/training-material/topics/dev/tutorials/writing_tests/tutorial.html" title="Show view statistics of this page">
            <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> Page Metrics
        </a>

        <!-- link to feedback -->
        
            
            
                <a class="dropdown-item" href="/training-material/feedback.html" title="Show feedback statistics about this repository">
                    <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN feedback
                </a>
            
        

        <div class="dropdown-item">
            <div>
                <i class="fas fa-palette" aria-hidden="true"></i><span class="visually-hidden">gtn-theme</span> Theme
            </div>

            <div id="theme-selector" data-toggle="buttons">
                    <button class="btn" data-theme="default">Default</button>
                    <button class="btn" data-theme="night">Night</button>
                    <button class="btn" data-theme="midnight">Midnight</button>
                    <button class="btn" data-theme="rainbow">Rainbow</button>
                    <button class="btn" data-theme="blm">✊🏿</button>
                    <button class="btn" data-theme="progress" >🏳️‍🌈</button>
                    <button class="btn" data-theme="halloween">🎃</button>
                    <button class="btn" data-theme="straya">🇦🇺</button>
            </div>

        </div>

        <div class="dropdown-item">
            <div>
                <i class="fas fa-history" aria-hidden="true"></i><span class="visually-hidden">galaxy-rulebuilder-history</span> Previous Versions
            </div>

            <div id="archive-selector">
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/2022-05-01/topics/dev/tutorials/writing_tests/tutorial.html" title="Version 2022-05-01">2022-05-01</a>
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/2022-04-01/topics/dev/tutorials/writing_tests/tutorial.html" title="Version 2022-04-01">2022-04-01</a>
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/2022-03-01/topics/dev/tutorials/writing_tests/tutorial.html" title="Version 2022-03-01">2022-03-01</a>
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/" title="Older Versions">Older Versions</a>
            </div>

        </div>

    </div>
</li>


                    <!-- Search bar-->
                    <li class="nav-item">
                      <div id="navbarSupportedContent" role="search">
                        <!-- Search form -->
                        <form class="form-inline mr-auto" method="GET" action="/training-material/search">
                          <i class="fas fa-search nav-link" aria-hidden="true"></i>
                          <div class="md-form mb-2">
                            <input name="query" class="form-control nicer" type="text" placeholder="Search Tutorials" aria-label="Search">
                          </div>
                        </form>
                      </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

        <div class="container main-content" role="main">
        











<!-- Gitter -->




<script>
  ((window.gitter = {}).chat = {}).options = {
  room: 'galaxyproject/dev'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

<section class="tutorial topic-dev">
    <h1 data-toc-skip>Writing Automated Tests for Galaxy</h1>
    

    <div markdown="0">

	<div class="contributors-line">
		Authors: <a href="/training-material/hall-of-fame/jdavcs/" class="contributor-badge contributor-jdavcs"><img src="/training-material/assets/images/orcid.png" alt="orcid logo"/><img src="https://avatars.githubusercontent.com/jdavcs?s=27" alt="Avatar">John Davis</a><a href="/training-material/hall-of-fame/jmchilton/" class="contributor-badge contributor-jmchilton"><img src="/training-material/assets/images/orcid.png" alt="orcid logo"/><img src="https://avatars.githubusercontent.com/jmchilton?s=27" alt="Avatar">John Chilton</a>
	</div>

</div>


    <blockquote class="overview">
        <div class="box-title" aria-label="overview box">Overview</div>
        
        <img alt="Creative Commons License" class="float-right" style="border-width:0; display: inline-block; margin:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" aria-hidden="true" />
        
        <strong><i class="far fa-question-circle" aria-hidden="true"></i> Questions:</strong>
        <ul>
        
        </ul>

        <strong><i class="fas fa-bullseye" aria-hidden="true"></i> Objectives: </strong>
        <ul>
        
        <li><p>Learn about the different types of automated tests in Galaxy</p>
</li>
        
        <li><p>Learn to write API tests</p>
</li>
        
        <li><p>Learn to write unit tests</p>
</li>
        
        </ul>

        
        <strong><i class="fas fa-check-circle" aria-hidden="true"></i> Requirements:</strong>
        <ul>
        
        
    <li>
    
        Familiarity with basic Git commands
    
    </li>

    <li>
    
        Basic knowledge of Python and JavaScript
    
    </li>

    <li>
    
        Mac OS or Linux that can run Galaxy & your favorite IDE or editor
    
    </li>

    <li>
    
        
        
        <a href="/training-material/topics/dev">Development in Galaxy</a>
        
            <ul>
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Galaxy Code Architecture:
                            
                                <a href="/training-material/topics/dev/tutorials/architecture/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
            </ul>
        
    
    </li>

        </ul>
        

        
        <div><strong><i class="fas fa-hourglass-half" aria-hidden="true"></i> Time estimation:</strong> 3 hours</div>
        

        

        
        

        
        <div id="supporting-materials"><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials:</strong></div>
        <ul class="supporting_material">
            

            

            

            

            

            
            
            

            <!-- Check the GTN Video Library for recordings of this tutorial or associated slides -->
            













  



            
                <li class="btn btn-default supporting_material">


    <a href="#" class="btn btn-default dropdown-toggle topic-icon" data-toggle="dropdown" aria-expanded="false" title="Where to run the tutorial">
        <i class="fas fa-globe" aria-hidden="true"></i><span class="visually-hidden">instances</span>&nbsp;Available on these Galaxies 
    </a>
    <ul class="dropdown-menu">
    
        <li>
            <a class="dropdown-item" href="https://github.com/galaxyproject/training-material/tree/main/topics/dev/docker" title="Docker image for this tutorial">
                <i class="fab fa-docker" aria-hidden="true"></i><span class="visually-hidden">docker_image</span> Docker image
            </a>
        </li>
    
    
    </ul>


</li>
            
        </ul>
        

        <div><strong><i class="far fa-calendar" aria-hidden="true"></i> Last modification:</strong> Jan 23, 2023 </div>
        <div><strong><i class="fas fa-balance-scale" aria-hidden="true"></i> License:</strong>
            
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Tutorial Content is licensed under Creative Commons Attribution 4.0 International License</a>
            
            <a rel="license" href="https://github.com/galaxyproject/training-material/blob/main/LICENSE.md">The GTN Framework is licensed under MIT</a>
        </div>
    </blockquote>

    <div class="container">
        <div class="row">
            <!-- sidebar, which will move to the top on a small screen -->
            <div class="col-sm-2">
                <nav id="toc" data-toggle="toc" class="sticky-top" aria-label="Table of Contents"></nav>
            </div>
            <div class="col-sm-10">
                 

                <blockquote class="agenda">
  <div id="agenda" class="box-title" aria-label="agenda box: ">Agenda</div>

<ol id="markdown-toc">
  <li><a href="#testing-in-galaxy" id="markdown-toc-testing-in-galaxy">Testing in <span class="notranslate">Galaxy</span></a></li>
  <li><a href="#local-development-environment-setup" id="markdown-toc-local-development-environment-setup">Local development environment setup</a></li>
  <li><a href="#api-tests" id="markdown-toc-api-tests">API tests</a>    <ol>
      <li><a href="#basic-api-test" id="markdown-toc-basic-api-test">Basic API test</a></li>
      <li><a href="#test-creating-a-simple-object" id="markdown-toc-test-creating-a-simple-object">Test creating a simple object</a></li>
      <li><a href="#a-better-test-for-creating-a-simple-object" id="markdown-toc-a-better-test-for-creating-a-simple-object">A better test for creating a simple object</a></li>
      <li><a href="#use-galaxys-populators-for-setting-up-database-state" id="markdown-toc-use-galaxys-populators-for-setting-up-database-state">Use <span class="notranslate">Galaxy</span>’s populators for setting up database state</a></li>
    </ol>
  </li>
  <li><a href="#unit-tests" id="markdown-toc-unit-tests">Unit tests</a>    <ol>
      <li><a href="#testing-simple-functions" id="markdown-toc-testing-simple-functions">Testing simple functions</a></li>
      <li><a href="#verifying-that-an-error-is-raised" id="markdown-toc-verifying-that-an-error-is-raised">Verifying that an error is raised</a></li>
      <li><a href="#using-fixtures-to-reduce-code-duplication" id="markdown-toc-using-fixtures-to-reduce-code-duplication">Using fixtures to reduce code duplication</a></li>
      <li><a href="#parametrization-of-test-functions" id="markdown-toc-parametrization-of-test-functions">Parametrization of test functions</a></li>
      <li><a href="#dealing-with-less-trivial-code" id="markdown-toc-dealing-with-less-trivial-code">Dealing with less trivial code</a></li>
      <li><a href="#mocking-a-dependency" id="markdown-toc-mocking-a-dependency">Mocking a dependency</a></li>
      <li><a href="#refactoring-for-testability" id="markdown-toc-refactoring-for-testability">Refactoring for testability</a></li>
      <li><a href="#monkeypatching-the-module-under-test" id="markdown-toc-monkeypatching-the-module-under-test">“Monkeypatching” the module under test</a></li>
      <li><a href="#more-refactoring" id="markdown-toc-more-refactoring">More refactoring</a></li>
      <li><a href="#more-monkeypatching" id="markdown-toc-more-monkeypatching">More “monkeypatching”</a></li>
      <li><a href="#utilizing-the-mocks-to-test-the-logic" id="markdown-toc-utilizing-the-mocks-to-test-the-logic">Utilizing the mocks to test the logic</a></li>
      <li><a href="#reformatting-for-improved-readability" id="markdown-toc-reformatting-for-improved-readability">Reformatting for improved readability</a></li>
      <li><a href="#adding-the-remaining-tests" id="markdown-toc-adding-the-remaining-tests">Adding the remaining tests</a></li>
    </ol>
  </li>
</ol>

</blockquote>

<h1 id="testing-in-galaxy">Testing in <span class="notranslate">Galaxy</span></h1>

<p>The <span class="notranslate">Galaxy</span> code base contains thousands of tests that include tests of different types (unit vs. functional vs. end-to-end; client vs. backend, etc.) that are supported by a variety of testing frameworks and libraries. In this tutorial, we will offer a small, yet representative sample of the types of tests you might write, as well as the concepts and issues you may need to be familiar with when writing tests for <span class="notranslate">Galaxy</span> code, whether as part of a new feature you are implementing, or as a standalone contribution to <span class="notranslate">Galaxy</span>’s testing code.</p>

<p>A good way to start learning about <span class="notranslate">Galaxy</span>’s testing infrastructure and how to use it is to read the documentation article on the different types of tests that are present in the code base as well as how to determine which type is most appropriate for a given scenario (see <a href="https://docs.galaxyproject.org/en/master/dev/writing_tests.html">Writing Tests for <span class="notranslate">Galaxy</span></a>).</p>

<p>In addition to reading the documentation, it is essential to have a reasonable understanding of <span class="notranslate">Galaxy</span>’s code organization. The best documentation resource for that is the <a href="/training-material/topics/dev/tutorials/architecture/slides.html"><span class="notranslate">Galaxy</span> Code Architecture slides</a>. In addition, we recommend the <a href="/training-material/topics/dev/tutorials/core-contributing/tutorial.html">Contributing a New Feature to <span class="notranslate">Galaxy</span> Core</a> tutorial, which, among other things, combines some of the concepts from the architecture slides with the material covered in this tutorial.</p>

<p>The most detailed and up-to-date documentation on running <span class="notranslate">Galaxy</span> tests is located at the top of the <code class="language-plaintext highlighter-rouge">run_tests.sh</code> script in <span class="notranslate">Galaxy</span>’s root directory.</p>

<p>To run <span class="notranslate">Galaxy</span> tests, you may also use the <code class="language-plaintext highlighter-rouge">pytest</code> command directly (except for client tests, which provide their own infrastructure and scripts described in <code class="language-plaintext highlighter-rouge">client/README.md</code>. Using pytest directly is most convenient for running individual tests (although you might have to manually set the required environment variables for all but unit tests, as per documentation in <code class="language-plaintext highlighter-rouge">run_tests.sh</code>). However, keep in mind that the <code class="language-plaintext highlighter-rouge">run_scripts.sh</code> script optimizes the tests by reusing the same <span class="notranslate">Galaxy</span> instance and database for API tests, so running API tests in batch with pytest would be very inefficient.</p>

<p>Another useful resource is the <a href="/training-material/topics/dev/tutorials/debugging/tutorial.html">Debugging <span class="notranslate">Galaxy</span></a> tutorial which contains a lot of useful information on how to debug test failures that occur both locally and remotely.</p>

<p>Finally, nothing can substitute studying <span class="notranslate">Galaxy</span>’s test code - we encourage you to always look for examples of similar tests and testing scenarios before you write your own.</p>

<h1 id="local-development-environment-setup">Local development environment setup</h1>

<!--SNIPPET-->
<blockquote class="tip">   <div id="tip-how-to-contribute-to-galaxy" class="box-title"><button type="button" aria-controls="tip-how-to-contribute-to-galaxy-contents" aria-expanded="true" aria-label="Toggle tip box: How to Contribute to Galaxy"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: How to Contribute to <span class="notranslate">Galaxy</span><span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>   <p>To contribute to <span class="notranslate">galaxy</span>, a GitHub account is required. Changes are proposed via a <a href="https://docs.github.com/en/github/collaborating-with-pull-requests">pull request</a>. This allows the project maintainers to review the changes and suggest improvements.</p>   <p>The general steps are as follows:</p>   <ol>   <li>Fork the <span class="notranslate">Galaxy</span> repository</li>   <li>Clone your fork</li>   <li>Make changes in a new branch</li>   <li>Commit your changes, push branch to your fork</li>   <li>Open a pull request for this branch in the <span class="notranslate">upstream</span> <span class="notranslate">Galaxy</span> repository</li> </ol>   <blockquote class="details">   <div id="details-git-github-and-span-class-quot-notranslate-quot-galaxy-span-core" class="box-title"><button type="button" aria-controls="details-git-github-and-span-class-quot-notranslate-quot-galaxy-span-core-contents" aria-expanded="true" aria-label="Toggle details box: Git, Github, and <span class=&quot;notranslate&quot;>Galaxy</span> Core"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden"></span> Details: Git, Github, and <span class=&quot;notranslate&quot;>Galaxy</span> Core<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>   <p>For a lot more information about Git branching and managing a repository on Github,  see the <a href="/training-material/topics/contributing/tutorials/github-command-line-contribution/tutorial.html">Contributing with GitHub via command-line</a> tutorial.</p>   <p>The <a href="/training-material/topics/dev/tutorials/architecture/slides.html"><span class="notranslate">Galaxy</span> Core Architecture slides</a> have a lot of important <span class="notranslate">Galaxy</span> core-related information related to branches,  project management, and contributing to <span class="notranslate">Galaxy</span> - under the Project Management section of the slides.</p> </blockquote> </blockquote>

<blockquote class="notranslate hands_on">
  <div id="hands-on-setup-your-local-galaxy-instance" class="box-title" aria-label="hands-on box: Setup your local Galaxy instance"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden"></span> Hands-on: Setup your local <span class="notranslate">Galaxy</span> instance</div>

  <ol>
    <li>Use GitHub UI to fork <span class="notranslate">Galaxy</span>’s repository at <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>project/<span class="notranslate">galaxy</span></code>.</li>
    <li>
      <p>Clone your forked repository to a local path, further referred to as <code class="language-plaintext highlighter-rouge"><span class="notranslate">GALAXY</span>_ROOT</code> and <code class="language-plaintext highlighter-rouge">cd</code> into <code class="language-plaintext highlighter-rouge"><span class="notranslate">GALAXY</span>_ROOT</code>. Note that we specify the tutorial branch with the <code class="language-plaintext highlighter-rouge">-b</code> option:</p>

      <blockquote class="code-in">
        <div id="code-in-bash" class="box-title" aria-label="code-in box: Bash"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden"></span> Input: Bash</div>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/&lt;your-use<span class="notranslate">rna</span>me&gt;/<span class="notranslate">galaxy</span> <span class="notranslate">GALAXY</span>_ROOT
<span class="nb">cd </span><span class="notranslate">GALAXY</span>_ROOT
</code></pre></div>        </div>
      </blockquote>
    </li>
    <li>
      <p>Before we can use <span class="notranslate">Galaxy</span>, we need to create a virtual environment and install the required dependencies. This is generally done with the <code class="language-plaintext highlighter-rouge">common_startup.sh</code> script:</p>

      <blockquote class="code-in">
        <div id="code-in-bash-1" class="box-title" aria-label="code-in box: Bash"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden"></span> Input: Bash</div>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash scripts/common_startup.sh <span class="nt">--dev-wheels</span>
</code></pre></div>        </div>
      </blockquote>

      <p>Make sure your Python version is at least 3.7 (you can check your Python version with <code class="language-plaintext highlighter-rouge">python --version</code>). If your system uses an older version, you may specify an alte<span class="notranslate">rna</span>tive Python interpreter using the <code class="language-plaintext highlighter-rouge"><span class="notranslate">GALAXY</span>_PYTHON</code> environment variable (<code class="language-plaintext highlighter-rouge"><span class="notranslate">GALAXY</span>_PYTHON=/path/to/alt/python bash scripts/common_startup.sh --dev-wheels</code>).</p>
    </li>
    <li>
      <p>Activate your new virtual environment:</p>

      <blockquote class="code-in">
        <div id="code-in-bash-2" class="box-title" aria-label="code-in box: Bash"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden"></span> Input: Bash</div>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span> .venv/bin/activate
</code></pre></div>        </div>
      </blockquote>

      <p>Once activated, you’ll see the name of the virtual environment prepended to your shell prompt: <code class="language-plaintext highlighter-rouge">(.venv)$</code>.</p>
    </li>
    <li>
      <p>Finally, let’s create a new branch for your edits:</p>

      <blockquote class="code-in">
        <div id="code-in-bash-3" class="box-title" aria-label="code-in box: Bash"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden"></span> Input: Bash</div>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout <span class="nt">-b</span> my-training
</code></pre></div>        </div>
      </blockquote>

      <p>Now when you run <code class="language-plaintext highlighter-rouge">git branch</code> you’ll see that your new branch is activated:</p>

      <blockquote class="code-2col">
        <blockquote class="code-in">
          <div id="code-in-bash-4" class="box-title" aria-label="code-in box: Bash"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden"></span> Input: Bash</div>
          <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git branch
</code></pre></div>          </div>
        </blockquote>

        <blockquote class="code-out">
          <div id="code-out" class="box-title" aria-label="code-out box: "><i class="fas fa-laptop-code" aria-hidden="true"></i><span class="visually-hidden"></span> Output</div>
          <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  training
<span class="k">*</span> my-training
</code></pre></div>          </div>
        </blockquote>
      </blockquote>

      <p>Note: <code class="language-plaintext highlighter-rouge">my-training</code> is just an example; you can call your new branch anything you like.</p>
    </li>
  </ol>
</blockquote>

<h1 id="api-tests">API tests</h1>

<p>We turn to API tests when we need to test some feature that requires a running <span class="notranslate">Galaxy</span> instance and, in many cases, the <span class="notranslate">Galaxy</span> database. These tests use the <span class="notranslate">Galaxy</span> API to drive the test.</p>

<p>In a way, these tests may be the simplest to write. While the required setup of an API test is, certainly, more involved than that of a basic unit test, <span class="notranslate">Galaxy</span>’s testing infrastructure takes care of all the heavy lifting, such as creating a test database, configuring and starting up a <span class="notranslate">Galaxy</span> instance, and tearing down the setup upon test completion. The testing infrastructure also provides a wealth of convenient abstractions that simplify pre-populating the database with the necessary state for each test, interacting with the API, as well as expressing expectations about the outcomes of a test. Thus, writing an API test boils down to calling the appropriate API endpoint and verifying the result.</p>

<p>We are not developing any new features in this tutorial (check out the <a href="/training-material/topics/dev/tutorials/core-contributing/tutorial.html">Contributing a New Feature to <span class="notranslate">Galaxy</span> Core</a> tutorial). However, we need to exercise the API, so we will be using existing <span class="notranslate">Galaxy</span> functionality as our testing context. Much of that functionality is already covered by tests. Existing tests may include advanced concepts or details on <span class="notranslate">Galaxy</span>’s inte<span class="notranslate">rna</span>ls that are beyond the scope of a tutorial on testing, so they are not optimal as examples for training. Therefore, the approach we will use is as follows:</p>

<ol>
  <li>Pick a controller <code class="language-plaintext highlighter-rouge">foo</code> in the <code class="language-plaintext highlighter-rouge">lib/<span class="notranslate">galaxy</span>/webapps/<span class="notranslate">galaxy</span>/api</code> directory.</li>
  <li>Pick one of the existing endpoints from the selected controller. If the endpoint represents a <code class="language-plaintext highlighter-rouge">GET</code> request (e.g. <code class="language-plaintext highlighter-rouge">@router.get("/api/foos</code>), you may be able to view the results on a running instance at <code class="language-plaintext highlighter-rouge">[host]/api/foos</code></li>
  <li>Write a new test to verify the specified functionality.</li>
</ol>

<p>Ideally, we’d like to follow the process of test-driven development: write a test, run it and watch it fail, implement the functionality under test, rerun the test to verify it passes. Although we are not developing any new functionality here, we still would like to verify that the test we have written is a legitimate test of the correctness of the underlying code. In other words, we want it to be deterministic, and fail if the input is invalid. For this, you may want to intentionally break the test on its first run to verify it doesn’t pass under any condition. Then fix the test and rerun. Although this doesn’t guarantee correctness, it helps prevent obvious errors in the testing code (such as forgetting to edit the endpoint after cutting and pasting code from a similar test function.</p>

<h2 id="basic-api-test">Basic API test</h2>

<p>Let’s start by writing a basic test for a very simple API endpoint: <code class="language-plaintext highlighter-rouge">api/version</code>. The controller for this endpoint is located at <code class="language-plaintext highlighter-rouge">lib/<span class="notranslate">galaxy</span>/webapps/<span class="notranslate">galaxy</span>/api/configuration.py</code>. You can check the format of the data at <code class="language-plaintext highlighter-rouge">https://use<span class="notranslate">galaxy</span>.org/api/version</code>.</p>

<p>First, you need to create a new file at <code class="language-plaintext highlighter-rouge">lib/<span class="notranslate">galaxy</span>_test/api/test_mytutorial.py</code>. For simplicity, we’ll place all new tests in this module. Next, add a class definition for <code class="language-plaintext highlighter-rouge">MyTutorialApiTestCase</code> that should be a subclass of <code class="language-plaintext highlighter-rouge">ApiTestCase</code>. Then add a test method, <code class="language-plaintext highlighter-rouge">test_version_is_current</code>, where you will (1) call the API via the <code class="language-plaintext highlighter-rouge">_get</code> method that returns a response object; and (2) verify that the response contains the “22.09” version number (assuming you have cloned the “dev” branch; otherwise your version may be different).</p>

<p>If your test fails, one way to debug it is to insert a <code class="language-plaintext highlighter-rouge">breakpoint()</code> statement into the body of the test (right after the call to <code class="language-plaintext highlighter-rouge">_get</code> would be a logical spot), and then use <a href="https://docs.python.org/3/library/pdb.html">pdb</a>, Python’s interactive debugger, to explore the response at runtime with the test paused (see <a href="/training-material/topics/dev/tutorials/debugging/tutorial.html">Debugging <span class="notranslate">Galaxy</span></a> for more details on using pdb to debug <span class="notranslate">Galaxy</span>).</p>

<blockquote class="solution">
  <div id="solution" class="box-title"><button type="button" aria-controls="solution-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of a basic API test.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">._framework</span> <span class="kn">import</span> <span class="n">ApiTestCase</span>


<span class="k">class</span> <span class="nc">MyTutorialApiTestCase</span><span class="p">(</span><span class="n">ApiTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_version_is_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"version"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s">"version_major"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"22.09"</span>  <span class="c1"># Assuming you are on the "dev" branch
</span></code></pre></div>  </div>
</blockquote>

<p>You may notice that in the provided solution we also call <code class="language-plaintext highlighter-rouge">response.raise_for_status()</code>: this is a requests library function that verifies that the request was successful (of course, we can also explicitly check the status code). It is helpful to include this check, because otherwise, if an error is raised, the error message in the error log will be not as helpful. Try using a nonextistant endpoint and running the test with and without the <code class="language-plaintext highlighter-rouge">raise_for_status</code> call. Compare these error messages:</p>

<p>With the status check:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">requests.exceptions.HTTPError: 404 Client Error: Not Found for url: http://127.0.0.1:9584/api/versionx</code></li>
</ul>

<p>Without the status check:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">requests.exceptions.JSONDecodeError: Expecting value: line 1 column 1 (char 0)</code></li>
</ul>

<h2 id="test-creating-a-simple-object">Test creating a simple object</h2>

<p>Now let’s write an API test for adding a simple object. By “simple”, we mean that this object does not depend on any other objects, so, for example, we don’t need to provide a reference to a History or User object to create it. We will be creating a role, using the <code class="language-plaintext highlighter-rouge">api/roles</code> <code class="language-plaintext highlighter-rouge">POST</code> endpoint located at <code class="language-plaintext highlighter-rouge">lib/<span class="notranslate">galaxy</span>/webapps/<span class="notranslate">galaxy</span>/api/roles.py</code>.</p>

<p>To create a role, we need to call the <code class="language-plaintext highlighter-rouge">_post</code> method, passing it 4 arguments:</p>
<ul>
  <li>the string value of the endpoint</li>
  <li>the payload containing the data for the new Role object</li>
  <li>a boolean argument setting the format of the payload data: <code class="language-plaintext highlighter-rouge">json=True</code></li>
  <li>a boolean argument setting the test user’s admin status: <code class="language-plaintext highlighter-rouge">admin=True</code></li>
</ul>

<p>How do we know what data to include in the payload? Look at the method signature in the API:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>self, trans: ProvidesUserContext = DependsOnTrans, role_definition_model: RoleDefinitionModel = Body(...)
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">RoleDefinitionModel</code> is the Pydantic model that describes the structure of the data passed with this argument. Looking at its definition (check the import statement at the top of the file to find its location), we see the following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RoleDefinitionModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">RoleNameField</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">RoleDescriptionField</span>
    <span class="n">user_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">EncodedDatabaseIdField</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">"User IDs"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">group_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">EncodedDatabaseIdField</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">"Group IDs"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
</code></pre></div></div>

<p>Thus, we need to provide a name and a description, both of which are string values (the other members are optional), formatted as JSON. (For more details on how the API works, see <a href="https://fastapi.tiangolo.com/tutorial/">FastAPI’s excellent documentation</a>.)</p>

<p>The response will return the Role object, so testing it is straightforward.</p>

<blockquote class="solution">
  <div id="solution-1" class="box-title"><button type="button" aria-controls="solution-1-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>API test for creating an object.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyTutorialApiTestCase</span><span class="p">(</span><span class="n">ApiTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_create_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># prepare new role
</span>        <span class="n">name</span> <span class="o">=</span> <span class="s">"cool role"</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s">"description of this cool role"</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s">"description"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># add new role and verify
</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_post</span><span class="p">(</span><span class="s">"roles"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="s">"description"</span><span class="p">]</span> <span class="o">==</span> <span class="n">description</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="a-better-test-for-creating-a-simple-object">A better test for creating a simple object</h2>

<p>Can we do better? We can verify that the new object has been added by using another endpoint to retrieve that object from the database. Here’s a first take:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_create_role_WRONG</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">ROLE_COUNT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># verify no roles except one built-in role for test user
</span>    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"roles"</span><span class="p">)</span>
    <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROLE_COUNT</span>

    <span class="c1"># create role
</span>    <span class="n">name</span> <span class="o">=</span> <span class="s">'my cool name'</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s">'description of this cool role'</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s">"description"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_post</span><span class="p">(</span><span class="s">"roles"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
    <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="s">"description"</span><span class="p">]</span> <span class="o">==</span> <span class="n">description</span>

    <span class="c1"># verify role has been added
</span>    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"roles"</span><span class="p">)</span>
    <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROLE_COUNT</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></div>

<p>Everything is straightforward: we verify that there is only n=1 role currently present (a built-in for the test user), we add the role, then retrieve all roles and verify that the new total is n + 1. Unfortunately, <strong><em>this is the wrong approach</em></strong>. Try running this together with the previous version of the test - you’ll get an assertion error: there’s an extra role in the database!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FAILED lib/<span class="notranslate">galaxy</span>_test/api/test_mytutorial.py::MyTutorialApiTestCase::test_create_role_WRONG - AssertionError: assert 2 == 1
</code></pre></div></div>

<p>The reason for that is that we are using the same database for both tests, so whatever artifacts are created in one test will affect the following test if we make any kind of assumptions about the state of the database.</p>

<p>How do we rewrite this test without making assumptions about database state? We can’t retrieve the roles and use their initial quantity as our baseline: that’s a perfect recipe for a race condition (if some other test creates a role after we have counted the existing roles but before we have created our new role, our test will fail). Instead, we can use the role’s name (which is unique across all roles) to verify that our object has been added.</p>

<p>We could generate our own unique name, but we can also simply use an existing method used across <span class="notranslate">Galaxy</span>’s tests: <code class="language-plaintext highlighter-rouge">get_random_name()</code> (we need to add an import and override the <code class="language-plaintext highlighter-rouge">setUp</code> method for that: see the solution code). Now we have a test we can safely run together with our old test (or with any number of other tests that create role objects).</p>

<blockquote class="solution">
  <div id="solution-2" class="box-title"><button type="button" aria-controls="solution-2-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Alte<span class="notranslate">rna</span>tive test for creating an object. Note the <code class="language-plaintext highlighter-rouge">setUp</code> method and the new import.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn"><span class="notranslate">galaxy</span>_test.base.populators</span> <span class="kn">import</span> <span class="n">DatasetPopulator</span>
<span class="kn">from</span> <span class="nn">._framework</span> <span class="kn">import</span> <span class="n">ApiTestCase</span>


<span class="k">class</span> <span class="nc">MyTutorialApiTestCase</span><span class="p">(</span><span class="n">ApiTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span> <span class="o">=</span> <span class="n">DatasetPopulator</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n"><span class="notranslate">galaxy</span>_interactor</span><span class="p">)</span>

<span class="c1"># [code omitted]
</span>
    <span class="k">def</span> <span class="nf">test_create_role2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># prepare new role
</span>        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">get_random_name</span><span class="p">()</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s">'description of this cool role'</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s">"description"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># verify new role does not exist
</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"roles"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">role</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># add new role
</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_post</span><span class="p">(</span><span class="s">"roles"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="s">"description"</span><span class="p">]</span> <span class="o">==</span> <span class="n">description</span>

        <span class="c1"># verify role has been added
</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"roles"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">role</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Can’t we destroy and create or re-populate the database for each test? We can, and if you absolutely need to do that, there is infrastructure for that in <code class="language-plaintext highlighter-rouge">test/unit/data/model/testing_utils</code> - you can see examples of its usage in the <span class="notranslate">mapping</span> and migrations unit tests (check these subdirectories). However, setting up and initializing the database is an expensive operation, which will be noticeable for a single test; <span class="notranslate">Galaxy</span> has hundreds of tests that rely on the database, so providing a fresh copy of the database for each test function is infeasible.</p>

<h2 id="use-galaxys-populators-for-setting-up-database-state">Use <span class="notranslate">Galaxy</span>’s populators for setting up database state</h2>

<p>As our last example, we’ll look at how to take advantage of some of the many abstractions provided by <span class="notranslate">Galaxy</span>’s testing infrastructure. Supposing you’d like to test the “datasets-filter-by-history” functionality exposed via the <code class="language-plaintext highlighter-rouge">api/datasets</code> endpoint (see <code class="language-plaintext highlighter-rouge">lib/<span class="notranslate">galaxy</span>/webapps/<span class="notranslate">galaxy</span>/api/datasets.py</code>). The test design is straightforward:</p>
<ul>
  <li>Create 2 history objects h1 and h2.</li>
  <li>Create n and m datasets associated with h1 and h2 respectively.</li>
  <li>Retrieve datasets filtering by h1. Verify there are n results.</li>
  <li>Retrieve datasets filtering by h2. Verify there are m results.</li>
</ul>

<p>The question is, how do we create the datasets and the histories (and all their respective dependencies?). One way would be to use the API for each such object. However, that would result in a barely readable test function which would mostly consist of setup code. Instead, we want our tests to be simple and understandable at a glance, and contain as little infrastructure code as possible. Enter dataset populators! This is one of many abstractions available to you that make it much easier to write tests that otherwise would have required nontrivial setup.</p>

<blockquote class="solution">
  <div id="solution-3" class="box-title"><button type="button" aria-controls="solution-3-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Using populators.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">test_search_dataset_by_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">history1_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">new_history</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">history2_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">new_history</span><span class="p">()</span>

        <span class="n">history1_datasets</span><span class="p">,</span> <span class="n">history2_datasets</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history1_datasets</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">new_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">history1_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history2_datasets</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">new_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">history2_id</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"history_id"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">history1_id</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"datasets"</span><span class="p">,</span> <span class="n">payload</span><span class="p">).</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="n">history1_datasets</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"history_id"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">history2_id</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"datasets"</span><span class="p">,</span> <span class="n">payload</span><span class="p">).</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="n">history2_datasets</span>
</code></pre></div>  </div>
</blockquote>

<p>Populators are used extensively throughout API tests as well as integration and Selenium tests to both setup database state, as well as access information from the <span class="notranslate">Galaxy</span> server. For more details, see the populators module at <code class="language-plaintext highlighter-rouge">lib/<span class="notranslate">galaxy</span>_test/base/populators.py</code>.</p>

<p>And we are done! Here’s the final version of the code we added to this testing module.</p>

<blockquote class="solution">
  <div id="solution-4" class="box-title"><button type="button" aria-controls="solution-4-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Final code.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn"><span class="notranslate">galaxy</span>_test.base.populators</span> <span class="kn">import</span> <span class="n">DatasetPopulator</span>
<span class="kn">from</span> <span class="nn">._framework</span> <span class="kn">import</span> <span class="n">ApiTestCase</span>


<span class="k">class</span> <span class="nc">MyTutorialApiTestCase</span><span class="p">(</span><span class="n">ApiTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span> <span class="o">=</span> <span class="n">DatasetPopulator</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n"><span class="notranslate">galaxy</span>_interactor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_version_is_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"version"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s">"version_major"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"22.09"</span>

    <span class="k">def</span> <span class="nf">test_create_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># prepare new role
</span>        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">get_random_name</span><span class="p">()</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s">'description of this cool role'</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s">"description"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># add new role and verify
</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_post</span><span class="p">(</span><span class="s">"roles"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="s">"description"</span><span class="p">]</span> <span class="o">==</span> <span class="n">description</span>

    <span class="k">def</span> <span class="nf">test_create_role2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># prepare new role
</span>        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">get_random_name</span><span class="p">()</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s">'description of this cool role'</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s">"description"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># verify new role does not exist
</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"roles"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">role</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># add new role
</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_post</span><span class="p">(</span><span class="s">"roles"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="s">"description"</span><span class="p">]</span> <span class="o">==</span> <span class="n">description</span>

        <span class="c1"># verify role has been added
</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"roles"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">role</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_search_dataset_by_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">history1_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">new_history</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">history2_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">new_history</span><span class="p">()</span>

        <span class="n">history1_datasets</span><span class="p">,</span> <span class="n">history2_datasets</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history1_datasets</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">new_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">history1_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history2_datasets</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="n">new_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">history2_id</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"history_id"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">history1_id</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"datasets"</span><span class="p">,</span> <span class="n">payload</span><span class="p">).</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="n">history1_datasets</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"history_id"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">history2_id</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get</span><span class="p">(</span><span class="s">"datasets"</span><span class="p">,</span> <span class="n">payload</span><span class="p">).</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="n">history2_datasets</span>
</code></pre></div>  </div>
</blockquote>

<h1 id="unit-tests">Unit tests</h1>

<p>Unit tests are best suited for testing well-defined, isolated functionality and, with rare exceptions, should not require a running <span class="notranslate">Galaxy</span> instance, a database, or any other exte<span class="notranslate">rna</span>l infrastructure. Unit tests are located in the <code class="language-plaintext highlighter-rouge">test/unit</code> directory.</p>

<p>There are numerous unit tests in the <span class="notranslate">Galaxy</span> code base. However, existing unit tests do not cover the entire code base and do not verify all the relevant logic (so there is plenty of space for improvement, and new contributions are always welcome!) In this tutorial, we will be writing unit tests for such code.</p>

<h2 id="testing-simple-functions">Testing simple functions</h2>

<p>We’ll start by looking at the module <code class="language-plaintext highlighter-rouge">lib/<span class="notranslate">galaxy</span>/util/bytesize.py</code>. This module is not covered by unit tests. There are 2 obvious targets for unit tests: the <code class="language-plaintext highlighter-rouge">parse bytesize</code> function and the <code class="language-plaintext highlighter-rouge">to_unit</code> method of the <code class="language-plaintext highlighter-rouge">ByteSize</code> class. Our goal is to come up with a reasonable selection of unit tests that verify essential aspects of this functionality.</p>

<p>We’ll start with the <code class="language-plaintext highlighter-rouge">parse_bytesize</code> function. Look at the code of the function and identify the logic that, you think, needs testing. Essentially, you want to ensure that any combination of valid input produces the expected output. Next, add a few tests. (see <a href="https://docs.pytest.org/en/7.1.x/how-to/assert.html">https://docs.pytest.org/en/7.1.x/how-to/assert.html</a> for examples)</p>

<blockquote class="solution">
  <div id="solution-5" class="box-title"><button type="button" aria-controls="solution-5-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of tests for the <code class="language-plaintext highlighter-rouge">parse_bytesize</code> function:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn"><span class="notranslate">galaxy</span>.util.bytesize</span> <span class="kn">import</span> <span class="n">ByteSize</span><span class="p">,</span> <span class="n">parse_bytesize</span>


<span class="k">def</span> <span class="nf">test_parse_bytesize_int_or_float</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">parse_bytesize</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="o">==</span> <span class="mi">42</span>
    <span class="k">assert</span> <span class="n">parse_bytesize</span><span class="p">(</span><span class="mf">42.5</span><span class="p">)</span> <span class="o">==</span> <span class="mf">42.5</span>


<span class="k">def</span> <span class="nf">test_parse_bytesize_str_no_suffix</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">parse_bytesize</span><span class="p">(</span><span class="s">'42'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">42</span>
    <span class="k">assert</span> <span class="n">parse_bytesize</span><span class="p">(</span><span class="s">'42.5'</span><span class="p">)</span> <span class="o">==</span> <span class="mf">42.5</span>


<span class="k">def</span> <span class="nf">test_parse_bytesize_str_suffix</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">parse_bytesize</span><span class="p">(</span><span class="s">'10K'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10000</span>
    <span class="k">assert</span> <span class="n">parse_bytesize</span><span class="p">(</span><span class="s">'10 KI'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10240</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify they pass. You can use the <code class="language-plaintext highlighter-rouge">pytest</code> command:</p>

<blockquote class="code-in">
  <div id="code-in-bash-5" class="box-title" aria-label="code-in box: Bash"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden"></span> Input: Bash</div>
  <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pytest <span class="nb">test</span>/unit/util/test_bytesize.py
</code></pre></div>  </div>
</blockquote>

<h2 id="verifying-that-an-error-is-raised">Verifying that an error is raised</h2>

<p>Now let’s add a test that verifies that invalid input raises an error, as expected.</p>

<blockquote class="solution">
  <div id="solution-6" class="box-title"><button type="button" aria-controls="solution-6-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of a test verifying a raised exception. Make sure you add the <code class="language-plaintext highlighter-rouge">pytest</code> import.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># [code omitted]
</span>
<span class="k">def</span> <span class="nf">test_parse_bytesize_str_invalid</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="p">.</span><span class="n">raises</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">):</span>
        <span class="n">parse_bytesize</span><span class="p">(</span><span class="s">'10 invalid-suffix'</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="p">.</span><span class="n">raises</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">):</span>
        <span class="n">parse_bytesize</span><span class="p">(</span><span class="s">'invalid-value'</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify they pass.</p>

<h2 id="using-fixtures-to-reduce-code-duplication">Using fixtures to reduce code duplication</h2>

<p>Let’s move on to the <code class="language-plaintext highlighter-rouge">to_unit</code> method of the <code class="language-plaintext highlighter-rouge">ByteSize</code>class. Just like you did for the previous function, add a few tests that verify that valid input produces expected output, and invalid input raises an error.</p>

<blockquote class="solution">
  <div id="solution-7" class="box-title"><button type="button" aria-controls="solution-7-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of tests for the <code class="language-plaintext highlighter-rouge">ByteSize.to_unit</code> method:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_bytesize_to_unit</span><span class="p">():</span>
    <span class="n">bytesize</span> <span class="o">=</span> <span class="n">ByteSize</span><span class="p">(</span><span class="mi">1_000_000_000_000_000</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'k'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1000000000000K'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'m'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1000000000M'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'g'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1000000G'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'t'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1000T'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'p'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1P'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'e'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'0E'</span>

    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'ki'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'976562500000KI'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'mi'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'953674316MI'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'gi'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'931322GI'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'ti'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'909TI'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'pi'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'0PI'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'ei'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'0EI'</span>

    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">()</span> <span class="o">==</span> <span class="s">'1000000000000000'</span>  <span class="c1"># no unit
</span>    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'K'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1000000000000K'</span>  <span class="c1"># uppercase unit
</span>

<span class="k">def</span> <span class="nf">test_bytesize_to_unit_as_str</span><span class="p">():</span>
    <span class="n">bytesize</span> <span class="o">=</span> <span class="n">ByteSize</span><span class="p">(</span><span class="mi">1_000_000_000_000_000</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'k'</span><span class="p">,</span> <span class="n">as_string</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1000000000000</span>  <span class="c1"># not to_string
</span>

<span class="k">def</span> <span class="nf">test_bytesize_to_unit_invalid</span><span class="p">():</span>
    <span class="n">bytesize</span> <span class="o">=</span> <span class="n">ByteSize</span><span class="p">(</span><span class="mi">1_000_000_000_000_000</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="p">.</span><span class="n">raises</span><span class="p">(</span><span class="nb">KeyError</span><span class="p">):</span>
        <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'invalid'</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify they pass.</p>

<p>Our tests are looking good for the most part, although code duplication is starting to creep in. It’s time to refactor!</p>

<p>Let’s start by factoring out the ByteSize object creation into a fixture (see <a href="https://docs.pytest.org/en/7.1.x/how-to/fixtures.html">https://docs.pytest.org/en/7.1.x/how-to/fixtures.html</a>). In this particular case moving this code into a fixture might be unnecessary, however, it provides an example of an approach that is very useful in more complex scenarios and is heavily used in <span class="notranslate">Galaxy</span>’s testing code.</p>

<blockquote class="solution">
  <div id="solution-8" class="box-title"><button type="button" aria-controls="solution-8-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Factoring out code into a fixture: we declare a fixture using pytest’s built-in <code class="language-plaintext highlighter-rouge">fixture</code> decorator,
and then simply pass it as an argument to our tests.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">bytesize</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">ByteSize</span><span class="p">(</span><span class="mi">1_000_000_000_000_000</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_bytesize_to_unit</span><span class="p">(</span><span class="n">bytesize</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'k'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1000000000000K'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'m'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1000000000M'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'g'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1000000G'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'t'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1000T'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'p'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1P'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'e'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'0E'</span>

    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'ki'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'976562500000KI'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'mi'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'953674316MI'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'gi'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'931322GI'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'ti'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'909TI'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'pi'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'0PI'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'ei'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'0EI'</span>

    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">()</span> <span class="o">==</span> <span class="s">'1000000000000000'</span>  <span class="c1"># no unit
</span>    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'K'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'1000000000000K'</span>  <span class="c1"># uppercase unit
</span>

<span class="k">def</span> <span class="nf">test_bytesize_to_unit_as_str</span><span class="p">(</span><span class="n">bytesize</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'k'</span><span class="p">,</span> <span class="n">as_string</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1000000000000</span>  <span class="c1"># not to_string
</span>

<span class="k">def</span> <span class="nf">test_bytesize_to_unit_invalid</span><span class="p">(</span><span class="n">bytesize</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="p">.</span><span class="n">raises</span><span class="p">(</span><span class="nb">KeyError</span><span class="p">):</span>
        <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="s">'invalid'</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify they pass.</p>

<h2 id="parametrization-of-test-functions">Parametrization of test functions</h2>

<p>Finally, our <code class="language-plaintext highlighter-rouge">test_bytesize_to_unit</code> test has a lot of assert statements of the same form. We can do better! Let’s use pytest’s test parametrization feature (see <a href="https://docs.pytest.org/en/7.1.x/how-to/parametrize.html">https://docs.pytest.org/en/7.1.x/how-to/parametrize.html</a>) to eliminate this redundancy. Again, as with the fixture example, this particular case would be fine without this feature. However, sometime you want to run the same test function on hundreds of different input combinations, in which case this feature is invaluable (e.g. <span class="notranslate">Galaxy</span>’s tool tests, or integration tests for configuration settings).</p>

<blockquote class="solution">
  <div id="solution-9" class="box-title"><button type="button" aria-controls="solution-9-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of parametrizing a test. Replace the previous version of <code class="language-plaintext highlighter-rouge">test_bytesize_to_unit</code> with the
following. Note that the test function takes 2 additional arguments.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s">"unit, expected_value"</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s">'k'</span><span class="p">,</span> <span class="s">'1000000000000K'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'m'</span><span class="p">,</span> <span class="s">'1000000000M'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'g'</span><span class="p">,</span> <span class="s">'1000000G'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'t'</span><span class="p">,</span> <span class="s">'1000T'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'p'</span><span class="p">,</span> <span class="s">'1P'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'e'</span><span class="p">,</span> <span class="s">'0E'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'ki'</span><span class="p">,</span> <span class="s">'976562500000KI'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'mi'</span><span class="p">,</span> <span class="s">'953674316MI'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'gi'</span><span class="p">,</span> <span class="s">'931322GI'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'ti'</span><span class="p">,</span> <span class="s">'909TI'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'pi'</span><span class="p">,</span> <span class="s">'0PI'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'ei'</span><span class="p">,</span> <span class="s">'0EI'</span><span class="p">),</span>
        <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">'1000000000000000'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'K'</span><span class="p">,</span> <span class="s">'1000000000000K'</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_bytesize_to_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">,</span> <span class="n">bytesize</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="n">to_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_value</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify they pass.</p>

<h2 id="dealing-with-less-trivial-code">Dealing with less trivial code</h2>

<p>So far we’ve been dealing with simple clean functions that had no exte<span class="notranslate">rna</span>l dependencies. However, quite often you will encounter lengthy blocks of code implementing nontrivial logic, that depend on objects that would be hard to instantiate in the context of a test. There are many excellent resources on this topic (the book <a href="https://www.oreilly.com/library/view/working-effectively-with/0131177052/">Working Effectively with Legacy Code</a> by Michael Feathers is but one example). In this tutorial, we’ll demonstrate a few basic approaches to handling such cases.</p>

<p>Your target module for the following exercises is <code class="language-plaintext highlighter-rouge">lib/<span class="notranslate">galaxy</span>/security/validate_user_input.py</code>. The unit tests for this module are located at <code class="language-plaintext highlighter-rouge">test/unit/data/security/test_validate_user_input.py</code>. You will be adding your code to this testing module.</p>

<p>If you look at the tests for this module, you’ll note that most of its functionality is directly or indirectly covered by tests. However, the <code class="language-plaintext highlighter-rouge">validate_email</code> function does not have tests - and that’s a shame for, despite being relatively small, it contains logic that is not immediately obvious (consider how the function behaves under different combinations of the allowlist and blocklist). That’s the function we’ll be testing.</p>

<p>The <code class="language-plaintext highlighter-rouge">validate_email</code> function is not fun to test. It depends on a Transaction and User objects - one does not simply <del>walk into Mordor</del> instantiate those in the context of a unit test. It has multiple paths of execution, to determine which it accesses the <span class="notranslate">Galaxy</span>Application object (which is a reference to a running instance of <span class="notranslate">Galaxy</span>) to access configuration values, the User object to check the value of its email attribute, and in addition to all that, of course, it calls the database. None of these dependencies require testing, at least not in the context of a unit test. However, we do want to verify the function’s core logic: the cases when no validation is required, when the provided email already exists, and the different combinations of the allowlist and blocklist.</p>

<h2 id="mocking-a-dependency">Mocking a dependency</h2>

<p>First, let’s test the case when the function returns early - when the email argument is the empty string or when its value is the same as the value of the <code class="language-plaintext highlighter-rouge">email</code> attribute of the provided User object. The first case is trivial, but the next one requires a User object. However, if we think about it, we only care about that user having a given string as its <code class="language-plaintext highlighter-rouge">email</code> attribute. So let’s use a “test double” - a stand-in empty object, and give it an <code class="language-plaintext highlighter-rouge">email</code> attribute. We’ll call it <code class="language-plaintext highlighter-rouge">MockUser</code> (strictly speaking, it’s a stub, and <a href="https://martinfowler.com/articles/mocksArentStubs.html">“mocks aren’t stubs”</a>, but we’ll follow the naming convention often used in <span class="notranslate">Galaxy</span>). We can pass <code class="language-plaintext highlighter-rouge">None</code> as the transaction object in both cases.</p>

<blockquote class="solution">
  <div id="solution-10" class="box-title"><button type="button" aria-controls="solution-10-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of replacing an object with a test double:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn"><span class="notranslate">galaxy</span>.security.validate_user_input</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">extract_domain</span><span class="p">,</span>
    <span class="n">validate_domain_resolves</span><span class="p">,</span>
    <span class="n">validate_email</span><span class="p">,</span>  <span class="c1"># we've added this import
</span>    <span class="n">validate_email_str</span><span class="p">,</span>
    <span class="n">validate_publicname_str</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">MockUser</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">test_email_is_empty</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>

<span class="k">def</span> <span class="nf">test_email_is_user_email</span><span class="p">():</span>
    <span class="n">my_email</span> <span class="o">=</span> <span class="s">"foo"</span>
    <span class="n">my_user</span> <span class="o">=</span> <span class="n">MockUser</span><span class="p">()</span>
    <span class="n">my_user</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">my_email</span>
    <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">my_email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">my_user</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>
</code></pre></div>  </div>
</blockquote>

<p>Now run the tests for this module:</p>

<blockquote class="code-in">
  <div id="code-in-bash-6" class="box-title" aria-label="code-in box: Bash"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden"></span> Input: Bash</div>
  <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pytest <span class="nb">test</span>/unit/data/security/test_validate_user_input.py
</code></pre></div>  </div>
</blockquote>

<blockquote class="warning">
  <div id="warning" class="box-title" aria-label="warning box: "><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden"></span> Warning</div>
  <p>As a word of caution, mocking (or any kind of patching to accommodate testing) may lead to brittle tests: by relying too much on <em>how</em> the logic is implemented, we’ll be forced to adjust the test each time that implementation changes. It’s a tradeoff between having narrowly-scoped tests that will point to the exact location of the problem but may lock the code under test into a given state, and higher-level integration-type tests that test the end result without “looking under the hood”, but may be less helpful when pinpointing the exact cause of a failed test. So, use sparingly and keep it simple.</p>
</blockquote>

<h2 id="refactoring-for-testability">Refactoring for testability</h2>

<p>Next, we’d like to test the case when the provided email already exists, or doesn’t exist. To determine the existence of an email the function calls the database - we don’t want to do that. Instead, we can simulate both conditions, like we simulated the user email in the previous exercise.</p>

<p>For this, we need to factor out the code that calls the database into its own function - then we can override that function for our test. So let’s modify <code class="language-plaintext highlighter-rouge">lib/<span class="notranslate">galaxy</span>/security/validate_user_input.py</code>.</p>

<blockquote class="solution">
  <div id="solution-11" class="box-title"><button type="button" aria-controls="solution-11-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Factoring out the database call.</p>

  <p>Old version:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">check_dup</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">validate_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="s">"""
    Validates the email format, also checks whether the domain is blocklisted in the disposable domains configuration.
    """</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">email</span> <span class="o">==</span> <span class="s">""</span> <span class="ow">and</span> <span class="n">allow_empty</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">""</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">validate_email_str</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">validate_domain</span><span class="p">:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">validate_domain_resolves</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

    <span class="c1"># Code to be refactored
</span>    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">message</span>
        <span class="ow">and</span> <span class="n">check_dup</span>
        <span class="ow">and</span> <span class="n">trans</span><span class="p">.</span><span class="n">sa_session</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">User</span><span class="p">)</span>
        <span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">lower</span><span class="p">(</span><span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">table</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">email</span><span class="p">)</span> <span class="o">==</span> <span class="n">email</span><span class="p">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="p">.</span><span class="n">first</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"User with email '</span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s">' already exists."</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
        <span class="c1"># If the allowlist is not empty filter out any domain not in the list and ignore blocklist.
</span>        <span class="k">if</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_allowlist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_allowlist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">"Please enter an allowed domain email address for this server."</span>
        <span class="c1"># If the blocklist is not empty filter out the disposable domains.
</span>        <span class="k">elif</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_blocklist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">base_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_blocklist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">"Please enter your permanent email address."</span>

    <span class="k">return</span> <span class="n">message</span>
</code></pre></div>  </div>

  <p>Refactored version:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">check_for_existing_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="n">user_record</span> <span class="o">=</span> <span class="p">(</span><span class="n">trans</span><span class="p">.</span><span class="n">sa_session</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">User</span><span class="p">)</span>
        <span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">lower</span><span class="p">(</span><span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">table</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">email</span><span class="p">)</span> <span class="o">==</span> <span class="n">email</span><span class="p">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="p">.</span><span class="n">first</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">user_record</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">check_dup</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">validate_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="s">"""
    Validates the email format, also checks whether the domain is blocklisted in the disposable domains configuration.
    """</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">email</span> <span class="o">==</span> <span class="s">""</span> <span class="ow">and</span> <span class="n">allow_empty</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">""</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">validate_email_str</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">validate_domain</span><span class="p">:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">validate_domain_resolves</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

    <span class="c1"># Refactored code
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">check_dup</span> <span class="ow">and</span> <span class="n">check_for_existing_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"User with email '</span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s">' already exists."</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
        <span class="c1"># If the allowlist is not empty filter out any domain not in the list and ignore blocklist.
</span>        <span class="k">if</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_allowlist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_allowlist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">"Please enter an allowed domain email address for this server."</span>
        <span class="c1"># If the blocklist is not empty filter out the disposable domains.
</span>        <span class="k">elif</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_blocklist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">base_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_blocklist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">"Please enter your permanent email address."</span>

    <span class="k">return</span> <span class="n">message</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="monkeypatching-the-module-under-test">“Monkeypatching” the module under test</h2>

<p>Now we can use pytest’s “monkeypatch” built-in fixture to replace that function with a stub method and then use it to return <code class="language-plaintext highlighter-rouge">True</code> or <code class="language-plaintext highlighter-rouge">False</code> to test both cases. (see <a href="https://docs.pytest.org/en/7.1.x/how-to/monkeypatch.html?highlight=monkeypatch">https://docs.pytest.org/en/7.1.x/how-to/monkeypatch.html?highlight=monkeypatch</a> for more details).</p>

<blockquote class="solution">
  <div id="solution-12" class="box-title"><button type="button" aria-controls="solution-12-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Monkeypatching the factored out function. Note the added import.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn"><span class="notranslate">galaxy</span>.security</span> <span class="kn">import</span> <span class="n">validate_user_input</span>

<span class="c1"># [code omitted]
</span>
<span class="k">def</span> <span class="nf">test_check_for_existing_email</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"duplicate_email@example.com"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">"exists"</span> <span class="ow">in</span> <span class="n">result</span>

    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"unique_email@example.com"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s">""</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="more-refactoring">More refactoring</h2>

<p>Run the tests to verify they pass after our latest modifications. But one test fails! The problem is that our validation function is not yet ready for testing: it still relies on the transaction object to access the running instance of <span class="notranslate">Galaxy</span> to retrieve 2 configuration settings: <code class="language-plaintext highlighter-rouge">email_domain_allowlist_content</code> and <code class="language-plaintext highlighter-rouge">email_domain_blocklist_content</code>.</p>

<p>How would you fix this problem?</p>

<blockquote class="solution">
  <div id="solution-13" class="box-title"><button type="button" aria-controls="solution-13-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Factor out the logic for obtaining both lists:</p>
  <ol>
    <li>Create 2 functions that take a transaction object as an argument and return the lists.</li>
    <li>Call the functions from the <code class="language-plaintext highlighter-rouge">validate_email</code> function’s body, assigning the results to
local variables.</li>
    <li>Replace all calls to <code class="language-plaintext highlighter-rouge">trans.app.config.[the list]</code> with the variables you’ve just assigned.</li>
  </ol>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_email_domain_allowlist_content</span><span class="p">(</span><span class="n">trans</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_allowlist_content</span>


<span class="k">def</span> <span class="nf">get_email_domain_blocklist_content</span><span class="p">(</span><span class="n">trans</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_blocklist_content</span>


<span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">check_dup</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">validate_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="s">"""
    Validates the email format, also checks whether the domain is blocklisted in the disposable domains configuration.
    """</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">email</span> <span class="o">==</span> <span class="s">""</span> <span class="ow">and</span> <span class="n">allow_empty</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">""</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">validate_email_str</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">validate_domain</span><span class="p">:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">validate_domain_resolves</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">check_dup</span> <span class="ow">and</span> <span class="n">check_for_existing_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"User with email '</span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s">' already exists."</span>

    <span class="n">email_domain_allowlist_content</span> <span class="o">=</span> <span class="n">get_email_domain_allowlist_content</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">email_domain_blocklist_content</span> <span class="o">=</span> <span class="n">get_email_domain_blocklist_content</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
        <span class="c1"># If the allowlist is not empty filter out any domain not in the list and ignore blocklist.
</span>        <span class="k">if</span> <span class="n">email_domain_allowlist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email_domain_allowlist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">"Please enter an allowed domain email address for this server."</span>
        <span class="c1"># If the blocklist is not empty filter out the disposable domains.
</span>        <span class="k">elif</span> <span class="n">email_domain_blocklist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">base_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">email_domain_blocklist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">"Please enter your permanent email address."</span>

    <span class="k">return</span> <span class="n">message</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="more-monkeypatching">More “monkeypatching”</h2>

<p>Run the tests. They still fail. That’s because we haven’t replaced the new functions with a mock for our test. Try to do that - it’s the same approach as we used for monkeypatching the <code class="language-plaintext highlighter-rouge">check_for_existing_email</code> function. Note that both lists should be <code class="language-plaintext highlighter-rouge">None</code> to be ignored.</p>

<blockquote class="solution">
  <div id="solution-14" class="box-title"><button type="button" aria-controls="solution-14-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Monkeypatch the email lists: return <code class="language-plaintext highlighter-rouge">None</code> for both, then override as needed:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_check_for_existing_email</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_allowlist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_blocklist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"duplicate_email@example.com"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">"exists"</span> <span class="ow">in</span> <span class="n">result</span>

    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"unique_email@example.com"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s">""</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests - they should pass now.</p>

<h2 id="utilizing-the-mocks-to-test-the-logic">Utilizing the mocks to test the logic</h2>

<p>Now that our tests pass, it’s time to test the last bit of logic: the allowlist and the blocklist. Our first step is to add a simple test to verify that if the allow-list is not empty, only emails with allowed domain names will be validated.</p>

<blockquote class="solution">
  <div id="solution-15" class="box-title"><button type="button" aria-controls="solution-15-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>First take on testing the allowlist.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_validate_email_allowlist_not_empty</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'good_domain.com'</span><span class="p">]</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_allowlist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_blocklist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@good_domain.com"</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>
    <span class="k">assert</span> <span class="s">"enter an allowed domain"</span> <span class="ow">in</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@bad_domain.com"</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify we haven’t broken anything.</p>

<p>However, again, we are getting a lot of duplication from our monkeypatching code, and there are more tests to come. Time to move some of it into fixtures; <strong>leave only the code that is specific to the test</strong>.</p>

<blockquote class="solution">
  <div id="solution-16" class="box-title"><button type="button" aria-controls="solution-16-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Factor out all common monkeypatching into fixtures. Note the <code class="language-plaintext highlighter-rouge">pytest</code> import.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># [code omitted]
</span>
<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">patch_allowlist</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_allowlist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>


<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">patch_blocklist</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_blocklist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>


<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">patch_check_existing</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_email_is_empty</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>


<span class="k">def</span> <span class="nf">test_email_is_user_email</span><span class="p">():</span>
    <span class="n">my_email</span> <span class="o">=</span> <span class="s">"foo"</span>
    <span class="n">my_user</span> <span class="o">=</span> <span class="n">MockUser</span><span class="p">()</span>
    <span class="n">my_user</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">my_email</span>
    <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">my_email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">my_user</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>


<span class="k">def</span> <span class="nf">test_check_for_existing_email</span><span class="p">(</span><span class="n">patch_allowlist</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"duplicate_email@example.com"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">"exists"</span> <span class="ow">in</span> <span class="n">result</span>

    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"unique_email@example.com"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s">""</span>


<span class="k">def</span> <span class="nf">test_validate_email_allowlist_not_empty</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">):</span>
    <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'good_domain.com'</span><span class="p">]</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_allowlist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@good_domain.com"</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>
    <span class="k">assert</span> <span class="s">"enter an allowed domain"</span> <span class="ow">in</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@bad_domain.com"</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Again, run the tests to verify we haven’t broken anything.</p>

<h2 id="reformatting-for-improved-readability">Reformatting for improved readability</h2>

<p>Before we add more tests, let’s reformat our code to group all the tests that target the <code class="language-plaintext highlighter-rouge">validate_email</code> function in one class. Keep in mind that each test gets its own instance of the class - so you cannot share instance state across tests. However, grouping related tests makes the testing module easier to navigate (there are more benefits; see <a href="https://docs.pytest.org/en/7.1.x/getting-started.html#group-multiple-tests-in-a-class">https://docs.pytest.org/en/7.1.x/getting-started.html#group-multiple-tests-in-a-class</a>).</p>

<blockquote class="solution">
  <div id="solution-17" class="box-title"><button type="button" aria-controls="solution-17-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Group related tests in one class. Note that you need to add <code class="language-plaintext highlighter-rouge">self</code> as the first
argument to each test function. You also need to add <code class="language-plaintext highlighter-rouge">self</code> to the call to <code class="language-plaintext highlighter-rouge">MockUser()</code>. Leave
the fixtures outside the class body, so that they can be reused by other test code.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestValidateEmail</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">MockUser</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">test_email_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>
    
    <span class="k">def</span> <span class="nf">test_email_is_user_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">my_email</span> <span class="o">=</span> <span class="s">"foo"</span>
        <span class="n">my_user</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">MockUser</span><span class="p">()</span>
        <span class="n">my_user</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">my_email</span>
        <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">my_email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">my_user</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>
    
    <span class="k">def</span> <span class="nf">test_check_for_existing_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patch_allowlist</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"duplicate_email@example.com"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s">"exists"</span> <span class="ow">in</span> <span class="n">result</span>
    
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"unique_email@example.com"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s">""</span>
    
    <span class="k">def</span> <span class="nf">test_validate_email_allowlist_not_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">):</span>
        <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'good_domain.com'</span><span class="p">]</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_allowlist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>
    
        <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@good_domain.com"</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>
        <span class="k">assert</span> <span class="s">"enter an allowed domain"</span> <span class="ow">in</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@bad_domain.com"</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Again, run the tests to verify we haven’t broken anything.</p>

<h2 id="adding-the-remaining-tests">Adding the remaining tests</h2>

<p>Now we have all the infrastructure in place. We need to add 2 more tests. First, you may notice that if the allowlist is not empty, the blocklist is ignored. Let’s write a test to verify this.</p>

<blockquote class="solution">
  <div id="solution-18" class="box-title"><button type="button" aria-controls="solution-18-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Testing ignoring the blocklist.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_ignore_blocklist_if_allowlist_not_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">):</span>
    <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'my_domain.com'</span><span class="p">]</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_allowlist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>

    <span class="c1"># but add that domain to blocklist too!
</span>    <span class="n">blocklist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'my_domain.com'</span><span class="p">]</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_blocklist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">blocklist</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@my_domain.com"</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>  <span class="c1"># we expect blocklist to be ignored
</span></code></pre></div>  </div>
</blockquote>

<p>Run the tests - they should pass.</p>

<p>Finally, let’s test the blocklist.</p>

<blockquote class="solution">
  <div id="solution-19" class="box-title"><button type="button" aria-controls="solution-19-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Testing the blocklist.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_blocklist_when_allowlist_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_allowlist</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">):</span>
    <span class="n">blocklist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'bad_domain.com'</span><span class="p">]</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validation_module</span><span class="p">,</span> <span class="s">"get_email_domain_blocklist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">blocklist</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">"enter your permanent email"</span> <span class="ow">in</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@bad_domain.com"</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests one last time - they should pass.</p>

<p>And we are done! Here’s the final version of the code we’ve added to this testing module.</p>

<blockquote class="solution">
  <div id="solution-20" class="box-title"><button type="button" aria-controls="solution-20-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Final code listing (excluding the 2 added imports).</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">patch_allowlist</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_allowlist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>

<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">patch_blocklist</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_blocklist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>

<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">patch_check_existing</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestValidateEmail</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">MockUser</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">test_email_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>
    
    <span class="k">def</span> <span class="nf">test_email_is_user_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">my_email</span> <span class="o">=</span> <span class="s">"foo"</span>
        <span class="n">my_user</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">MockUser</span><span class="p">()</span>
        <span class="n">my_user</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">my_email</span>
        <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">my_email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">my_user</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>
    
    <span class="k">def</span> <span class="nf">test_check_for_existing_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patch_allowlist</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"duplicate_email@example.com"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s">"exists"</span> <span class="ow">in</span> <span class="n">result</span>
    
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"check_for_existing_email"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"unique_email@example.com"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s">""</span>
    
    <span class="k">def</span> <span class="nf">test_validate_email_allowlist_not_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">):</span>
        <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'good_domain.com'</span><span class="p">]</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_allowlist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>
    
        <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@good_domain.com"</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>
        <span class="k">assert</span> <span class="s">"enter an allowed domain"</span> <span class="ow">in</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@bad_domain.com"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ignore_blocklist_if_allowlist_not_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">):</span>
        <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'my_domain.com'</span><span class="p">]</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_allowlist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>

        <span class="c1"># but add that domain to blocklist too!
</span>        <span class="n">blocklist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'my_domain.com'</span><span class="p">]</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="s">"get_email_domain_blocklist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">blocklist</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@my_domain.com"</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span>  <span class="c1"># we expect blocklist to be ignored
</span>
    <span class="k">def</span> <span class="nf">test_blocklist_when_allowlist_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_allowlist</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">):</span>
        <span class="n">blocklist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'bad_domain.com'</span><span class="p">]</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">validation_module</span><span class="p">,</span> <span class="s">"get_email_domain_blocklist_content"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">blocklist</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s">"enter your permanent email"</span> <span class="ow">in</span> <span class="n">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"email@bad_domain.com"</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>



                
                <blockquote class="key_points">
                    <div class="box-title" aria-label="key-points box"><i class="fas fa-key" aria-hidden="true"></i> Key points</div>
                    <ul>
                        
                        <li><p>Read the Writing Tests for Galaxy documentation article</p>
</li>
                        
                        <li><p>Check for existing examples of similar tests before implementing your own</p>
</li>
                        
                        <li><p>Prefer Galaxy’s abstractions to writing low level code whenever possible</p>
</li>
                        
                        <li><p>Write tests that do not depend on each other or the state of the database</p>
</li>
                        
                        <li><p>When testing the API, verify the return status code before checking the response data</p>
</li>
                        
                        <li><p>Refactor the code under test if that’s needed to make it testable</p>
</li>
                        
                        <li><p>Move redundant setup code into fixtures</p>
</li>
                        
                        <li><p>Use test doubles (mocks, stubs, etc.) sparingly</p>
</li>
                        
                    </ul>
                </blockquote>
                

                <h1>Frequently Asked Questions</h1>
                Have questions about this tutorial? Check out the  <a href="/training-material/topics/dev/faqs/">FAQ page for the Development in Galaxy topic</a> to see if your question is listed there.
                If not, please ask your question on the <a href="https://gitter.im/Galaxy-Training-Network/Lobby">GTN Gitter Channel</a> or the
                <a href="https://help.galaxyproject.org">Galaxy Help Forum</a>

                

                


                

                

                <h1>Feedback</h1>
                <p class="text-muted">Did you use this material as an instructor? Feel free to give us feedback on <a href="https://github.com/galaxyproject/training-material/issues/1452">how it went</a>.
                <br>Did you use this material as a learner or student? Click the form below to leave feedback.<i class="fas fa-hand-point-down"></i>
                </p>

                <div id="feedback-button">
                    <img src="/training-material/shared/images/feedback.png" title="Click to activate" alt="Click here to load Google feedback frame" />
                </div>
                <div id="feedback-form">
                </div>
                <script type="text/javascript">
                    (function (window, document) {
                        function onDocumentReady(fn) {
                            if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
                                fn();
                            } else {
                                document.addEventListener('DOMContentLoaded', fn);
                            }
                        }

                        onDocumentReady(function () {
                            $("#feedback-button").click(function(evt){
                                var e = $(evt.target)
                                e.hide();

                                $("#feedback-form").html(`
                                    <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Writing Automated Tests for Galaxy (Development in Galaxy)">Loading...</iframe>
                                `)
                            })
                        });
                    })(window, document);
                </script>

                <h1>Citing this Tutorial</h1>
                <p>
                    <ol>
                        <li id="citation-text">
                            John Davis, John Chilton,  <b>Writing Automated Tests for Galaxy (Galaxy Training Materials)</b>. <a href="https://training.galaxyproject.org/training-material/topics/dev/tutorials/writing_tests/tutorial.html">https://training.galaxyproject.org/training-material/topics/dev/tutorials/writing_tests/tutorial.html</a> Online; accessed TODAY
                        </li>
                        <li>
                        Batut et al., 2018 <b>Community-Driven Data Analysis Training for Biology</b> Cell Systems <a href="https://doi.org/10.1016%2Fj.cels.2018.05.012">10.1016/j.cels.2018.05.012</a>
                        </li>
                    </ol>
                </p>

                <!-- collapsible boxcontaining the BibTeX-formatted citation -->
                <blockquote class="details">

                  <div id="citation-bibtex" class="box-title">
                    <button type="button" aria-controls="citation-bibtex" aria-expanded="false" aria-label="Toggle details box: BibTeX for citing this tutorial">
                      <i class="fas fa-info-circle" aria-hidden="true"></i>
                      <span class="visually-hidden"></span> BibTeX<span role="button" class="fold-unfold fa fa-minus-square" aria-hidden="true"></span>
                    </button>
                   </div>
                   <p style="display: none;">

                   <div class="highlighter-rouge"><div class="highlight"><pre class="highlight">


<code id="citation-code">@misc{dev-writing_tests,
author = "John Davis and John Chilton",
title = "Writing Automated Tests for Galaxy (Galaxy Training Materials)",
year = "",
month = "",
day = ""
url = "\url{https://training.galaxyproject.org/training-material/topics/dev/tutorials/writing_tests/tutorial.html}",
note = "[Online; accessed TODAY]"
}
@article{Hiltemann_2023,
	doi = {10.1371/journal.pcbi.1010752},
	url = {https://doi.org/10.1371%2Fjournal.pcbi.1010752},
	year = 2023,
	month = {jan},
	publisher = {Public Library of Science ({PLoS})},
	volume = {19},
	number = {1},
	pages = {e1010752},
	author = {Saskia Hiltemann and Helena Rasche and Simon Gladman and Hans-Rudolf Hotz and Delphine Larivi{\`{e}}re and Daniel Blankenberg and Pratik D. Jagtap and Thomas Wollmann and Anthony Bretaudeau and Nadia Gou{\'{e}} and Timothy J. Griffin and Coline Royaux and Yvan Le Bras and Subina Mehta and Anna Syme and Frederik Coppens and Bert Droesbeke and Nicola Soranzo and Wendi Bacon and Fotis Psomopoulos and Crist{\'{o}}bal Gallardo-Alba and John Davis and Melanie Christine Föll and Matthias Fahrner and Maria A. Doyle and Beatriz Serrano-Solano and Anne Claire Fouilloux and Peter van Heusden and Wolfgang Maier and Dave Clements and Florian Heyl and Björn Grüning and B{\'{e}}r{\'{e}}nice Batut and},
	editor = {Francis Ouellette},
	title = {Galaxy Training: A powerful framework for teaching!},
	journal = {PLoS Comput Biol} Computational Biology}
}
</code>
                   </pre></div></div>
                   </p>
                </blockquote>

                


<script type="text/javascript">
// update the date on load, or leave fallback of 'today'
d = new Date();
document.getElementById("citation-code").innerHTML = document.getElementById("citation-code").innerHTML.replace("TODAY", d.toDateString());
document.getElementById("citation-text").innerHTML = document.getElementById("citation-text").innerHTML.replace("TODAY", d.toDateString());
</script>

                <i class="far fa-thumbs-up" aria-hidden="true"></i> Congratulations on successfully completing this tutorial!

                

                

            </div>
        </div>
    </div>
</section>
<br/>
<br/>
<br/>

        </div>
        
        <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
        <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
        <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
        <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
        <script type="text/javascript" src="/training-material/assets/js/main.js"></script>
        <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
        <script type="text/javascript">
        var snippets=document.querySelectorAll('div.highlight');
        [].forEach.call(snippets,function(snippet){
            snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
        });

        var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
            target:function(trigger){return trigger.nextElementSibling;
        }});
        </script>
        

        <script type="text/javascript">
            if(window.location.hostname === "galaxyproject.github.io") {
                // Redirect
                var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
                $('div.container.main-content').prepend("<div class='alert alert-warning'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

                window.setTimeout(function(){
                    window.location.href = redirect;
                }, 5000)

            }
        </script>
    </body>
</html>